<!-- Miner dashboard -->
<div class="miner-dashboard p-4 space-y-6"
     hx-ext="ws"
     ws-connect="/api/ws">
    
    <!-- Status overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4"
         ws-send
         ws-receive="type: metrics">
        <!-- Status card -->
        <div class="stat-card p-4 rounded-lg border {% if status.is_active %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %}">
            <h3 class="text-lg font-semibold">Status</h3>
            <div class="mt-2">
                <p class="text-2xl font-bold">
                    {% if status.is_active %}Mining{% else %}Inactive{% endif %}
                </p>
                <p class="text-sm text-gray-500">
                    Uptime: {{ status.uptime|format_duration }}
                </p>
            </div>
        </div>

        <!-- Success rate -->
        <div class="stat-card p-4 rounded-lg border bg-blue-50 border-blue-200">
            <h3 class="text-lg font-semibold">Success Rate</h3>
            <div class="mt-2">
                <p class="text-2xl font-bold success-rate">{{ metrics.success_rate * 100 }}%</p>
                <p class="text-sm text-gray-500">
                    {{ metrics.total_blocks }} blocks mined
                </p>
            </div>
        </div>

        <!-- Block time -->
        <div class="stat-card p-4 rounded-lg border bg-purple-50 border-purple-200">
            <h3 class="text-lg font-semibold">Block Time</h3>
            <div class="mt-2">
                <p class="text-2xl font-bold block-time">{{ metrics.average_block_time }}ms</p>
                <p class="text-sm text-gray-500">Average</p>
            </div>
        </div>

        <!-- Rewards -->
        <div class="stat-card p-4 rounded-lg border bg-yellow-50 border-yellow-200">
            <h3 class="text-lg font-semibold">Rewards</h3>
            <div class="mt-2">
                <p class="text-2xl font-bold rewards">{{ metrics.rewards_earned }}</p>
                <p class="text-sm text-gray-500">Total earned</p>
            </div>
        </div>
    </div>

    <!-- Stake overview -->
    <div class="stake-overview p-4 border rounded-lg bg-gray-50">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Total Stake</h3>
            <button class="btn btn-sm btn-primary"
                    hx-get="/components/miner/stake-form"
                    hx-target="#main-content">
                Manage Stake
            </button>
        </div>
        <div class="text-3xl font-bold">{{ total_stake }}</div>
        <div class="mt-2 text-sm text-gray-500">
            Staked across {{ active_modules|length }} modules
        </div>
    </div>

    <!-- Active modules -->
    <div class="active-modules">
        <h3 class="text-lg font-semibold mb-4">Active Modules</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for module in active_modules %}
            <div class="module-card p-4 border rounded-lg"
                 hx-get="/components/miner/module-status/{{ module }}"
                 hx-trigger="every 10s">
                <h4 class="font-medium">{{ module }}</h4>
                <!-- Module status will be loaded here -->
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Actions -->
    <div class="actions flex space-x-4">
        <button class="btn btn-primary"
                hx-get="/components/miner/config-form"
                hx-target="#main-content">
            Configure
        </button>
        {% if status.is_active %}
        <button class="btn btn-danger"
                hx-post="/api/miner/stop"
                hx-confirm="Stop all mining?">
            Stop All
        </button>
        {% else %}
        <button class="btn btn-success"
                hx-post="/api/miner/start">
            Start
        </button>
        {% endif %}
    </div>

    <!-- Performance chart -->
    <div class="performance-chart">
        <canvas id="minerMetricsChart"></canvas>
    </div>
</div>

<!-- WebSocket handling -->
<script>
let metricsChart = null;

document.addEventListener('htmx:wsOpen', function(evt) {
    console.log('WebSocket connected');
});

document.addEventListener('htmx:wsClose', function(evt) {
    console.log('WebSocket closed');
});

document.addEventListener('htmx:wsMessage', function(evt) {
    const message = JSON.parse(evt.detail.message);
    
    if (message.type === 'metrics') {
        updateMetrics(message.data);
    }
});

function updateMetrics(metrics) {
    // Update dashboard stats
    updateDashboardStats(metrics);
    
    // Update chart
    updateMetricsChart(metrics);
}

function updateDashboardStats(metrics) {
    // Update success rate
    document.querySelector('.success-rate').textContent = 
        `${(metrics.success_rate * 100).toFixed(1)}%`;
    
    // Update block time
    document.querySelector('.block-time').textContent = 
        `${metrics.average_block_time}ms`;
    
    // Update rewards
    document.querySelector('.rewards').textContent = 
        metrics.rewards_earned;
}

function updateMetricsChart(metrics) {
    const ctx = document.getElementById('minerMetricsChart');
    if (!ctx) return;

    if (!metricsChart) {
        metricsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Block Time',
                    data: [],
                    borderColor: 'rgb(79, 70, 229)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Update chart data
    const timestamp = new Date(metrics.timestamp).toLocaleTimeString();
    metricsChart.data.labels.push(timestamp);
    metricsChart.data.datasets[0].data.push(metrics.average_block_time);
    
    // Keep last 20 data points
    if (metricsChart.data.labels.length > 20) {
        metricsChart.data.labels.shift();
        metricsChart.data.datasets[0].data.shift();
    }
    
    metricsChart.update();
}
</script>
